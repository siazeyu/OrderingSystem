<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配送费测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .result { margin-top: 10px; padding: 10px; background-color: #f5f5f5; border-radius: 3px; }
        button { padding: 8px 15px; margin: 5px; background-color: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>配送费计算测试</h1>
    
    <div class="test-section">
        <h3>1. 获取商品列表</h3>
        <button onclick="getProducts()">获取商品</button>
        <div id="products-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>2. 添加商品到购物车</h3>
        <label>用户ID: <input type="number" id="userId" value="1"></label><br>
        <label>商品ID: <input type="number" id="productId" value="11"></label><br>
        <label>数量: <input type="number" id="quantity" value="2"></label><br>
        <button onclick="addToCart()">添加到购物车</button>
        <div id="cart-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>3. 创建订单（验证配送费计算）</h3>
        <label>用户ID: <input type="number" id="orderUserId" value="1"></label><br>
        <label>地址ID: <input type="number" id="addressId" value="1"></label><br>
        <button onclick="createOrder()">创建订单</button>
        <div id="order-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>4. 查看订单详情</h3>
        <label>订单ID: <input type="number" id="orderId" value=""></label><br>
        <button onclick="getOrderDetail()">查看订单</button>
        <div id="detail-result" class="result"></div>
    </div>

    <script src="js/api.js"></script>
    <script>
        let lastOrderId = '';

        function getProducts() {
            api.product.getAllProducts().then(response => {
                const result = document.getElementById('products-result');
                if (response.code === 200) {
                    result.innerHTML = '<div class="success">商品获取成功:</div><pre>' + JSON.stringify(response.data, null, 2) + '</pre>';
                } else {
                    result.innerHTML = '<div class="error">商品获取失败: ' + response.message + '</div>';
                }
            }).catch(error => {
                document.getElementById('products-result').innerHTML = '<div class="error">请求失败: ' + error + '</div>';
            });
        }

        function addToCart() {
            const userId = document.getElementById('userId').value;
            const productId = document.getElementById('productId').value;
            const quantity = document.getElementById('quantity').value;
            
            api.cart.addToCart(userId, productId, quantity).then(response => {
                const result = document.getElementById('cart-result');
                if (response.code === 200) {
                    result.innerHTML = '<div class="success">添加购物车成功:</div><pre>' + JSON.stringify(response.data, null, 2) + '</pre>';
                } else {
                    result.innerHTML = '<div class="error">添加购物车失败: ' + response.message + '</div>';
                }
            }).catch(error => {
                document.getElementById('cart-result').innerHTML = '<div class="error">请求失败: ' + error + '</div>';
            });
        }

        function createOrder() {
            const userId = document.getElementById('orderUserId').value;
            const addressId = document.getElementById('addressId').value;
            
            // 使用默认地址信息进行测试
            const deliveryAddress = "北京市朝阳区测试地址123号";
            const contactName = "测试用户";
            const contactPhone = "13800138000";
            
            api.order.createOrderFromCart(userId, '', deliveryAddress, contactName, contactPhone).then(response => {
                const result = document.getElementById('order-result');
                if (response.code === 200) {
                    lastOrderId = response.data.id;
                    document.getElementById('orderId').value = lastOrderId;
                    result.innerHTML = '<div class="success">订单创建成功!</div><pre>' + JSON.stringify(response.data, null, 2) + '</pre>';
                    
                    // 高亮显示配送费相关信息
                    const orderData = response.data;
                    const deliveryFeeInfo = `
                    <div style="background-color: #e7f3ff; padding: 10px; margin-top: 10px; border-radius: 5px;">
                        <h4>配送费计算结果:</h4>
                        <p><strong>商品总金额:</strong> ¥${orderData.totalAmount}</p>
                        <p><strong>配送费:</strong> ¥${orderData.deliveryFee}</p>
                        <p><strong>优惠金额:</strong> ¥${orderData.discountAmount || 0}</p>
                        <p><strong>实际支付金额:</strong> ¥${orderData.actualAmount}</p>
                        <p><strong>计算公式:</strong> 实际支付 = 商品总金额 + 配送费 - 优惠金额</p>
                    </div>`;
                    result.innerHTML += deliveryFeeInfo;
                } else {
                    result.innerHTML = '<div class="error">订单创建失败: ' + response.message + '</div>';
                }
            }).catch(error => {
                document.getElementById('order-result').innerHTML = '<div class="error">请求失败: ' + error + '</div>';
            });
        }

        function getOrderDetail() {
            const orderId = document.getElementById('orderId').value;
            if (!orderId) {
                document.getElementById('detail-result').innerHTML = '<div class="error">请输入订单ID</div>';
                return;
            }
            
            api.order.getOrderDetail(orderId).then(response => {
                const result = document.getElementById('detail-result');
                if (response.code === 200) {
                    result.innerHTML = '<div class="success">订单详情获取成功:</div><pre>' + JSON.stringify(response.data, null, 2) + '</pre>';
                } else {
                    result.innerHTML = '<div class="error">订单详情获取失败: ' + response.message + '</div>';
                }
            }).catch(error => {
                document.getElementById('detail-result').innerHTML = '<div class="error">请求失败: ' + error + '</div>';
            });
        }

        // 页面加载时自动获取商品列表
        window.onload = function() {
            getProducts();
        };
    </script>
</body>
</html>