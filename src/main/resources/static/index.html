<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‚¹é¤ç³»ç»Ÿ - é¦–é¡µ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f5f5;
        }

        .header {
            background-color: #ff6b6b;
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .nav {
            background-color: white;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
        }

        .nav-links a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: #ff6b6b;
        }

        .cart-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .cart-count {
            background-color: #ff6b6b;
            color: white;
            border-radius: 50%;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            min-width: 20px;
            text-align: center;
        }

        .main-content {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .categories {
            margin-bottom: 2rem;
        }

        .category-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .category-tab {
            padding: 0.5rem 1rem;
            background-color: white;
            border: 2px solid #ddd;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .category-tab.active {
            background-color: #ff6b6b;
            color: white;
            border-color: #ff6b6b;
        }

        .products {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .product-card {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .product-image {
            width: 100%;
            height: 200px;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #ccc;
        }

        .product-info {
            padding: 1rem;
        }

        .product-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .product-description {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }

        .product-price {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .current-price {
            font-size: 1.2rem;
            font-weight: 600;
            color: #ff6b6b;
        }

        .original-price {
            font-size: 0.9rem;
            color: #999;
            text-decoration: line-through;
        }

        .product-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: #ff6b6b;
            color: white;
            flex: 1;
        }

        .btn-primary:hover {
            background-color: #ff5252;
        }

        .btn-secondary {
            background-color: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background-color: #e0e0e0;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quantity-btn {
            width: 30px;
            height: 30px;
            border: 1px solid #ddd;
            background-color: white;
            cursor: pointer;
            border-radius: 4px;
        }

        .quantity-display {
            min-width: 30px;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 2rem;
            color: #ff6b6b;
        }

        /* ç”¨æˆ·ä¿¡æ¯æ ·å¼ */
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        #userInfo {
            cursor: pointer;
            padding: 0.5rem 1rem;
            background-color: #f0f0f0;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        #userInfo:hover {
            background-color: #e0e0e0;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 0;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid #eee;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #000;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .form-group input:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 0 2px rgba(255,107,107,0.2);
        }

        .form-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }

        .form-actions .btn {
            flex: 1;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
                gap: 1rem;
            }

            .products {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 1rem;
            }

            .category-tabs {
                justify-content: center;
            }
        }
    </style>
    <script src="js/api.js"></script>
</head>
<body>
    <header class="header">
        <h1>ğŸ” ç¾é£Ÿç‚¹é¤ç³»ç»Ÿ</h1>
        <p>æ–°é²œç¾å‘³ï¼Œå¿«é€Ÿé…é€</p>
    </header>

    <nav class="nav">
        <div class="nav-container">
            <div class="nav-links">
                <a href="#" onclick="showAllProducts()">é¦–é¡µ</a>
                <a href="#" onclick="showCart()">è´­ç‰©è½¦</a>
                <a href="#" onclick="showOrders()">æˆ‘çš„è®¢å•</a>
                <a href="#" onclick="showWallet()">æˆ‘çš„é’±åŒ…</a>
                <a href="#" onclick="showProfile()">ä¸ªäººèµ„æ–™</a>
                <a href="#" onclick="showAdmin()">å•†å®¶ç®¡ç†</a>
            </div>
            <div class="user-info">
                <span id="userInfo" onclick="showLoginModal()">æœªç™»å½•</span>
                <span id="logoutBtn" style="display:none; cursor:pointer; margin-left:10px;" onclick="logout()">é€€å‡º</span>
            </div>
            <div class="cart-info">
                <span>è´­ç‰©è½¦</span>
                <span class="cart-count" id="cartCount">0</span>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="categories">
            <div class="category-tabs" id="categoryTabs">
                <div class="category-tab active" onclick="filterByCategory(0)">å…¨éƒ¨</div>
            </div>
        </div>

        <div class="products" id="productsList">
            <div class="loading">æ­£åœ¨åŠ è½½å•†å“...</div>
        </div>
    </main>

    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div id="loginModal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç”¨æˆ·ç™»å½•</h3>
                <span class="close" onclick="closeLoginModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ç”¨æˆ·å/æ‰‹æœºå·ï¼š</label>
                    <input type="text" id="loginUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·åæˆ–æ‰‹æœºå·">
                </div>
                <div class="form-group">
                    <label>å¯†ç ï¼š</label>
                    <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="login()">ç™»å½•</button>
                    <button class="btn btn-secondary" onclick="showRegisterModal()">æ³¨å†Œè´¦å·</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ³¨å†Œæ¨¡æ€æ¡† -->
    <div id="registerModal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç”¨æˆ·æ³¨å†Œ</h3>
                <span class="close" onclick="closeRegisterModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ç”¨æˆ·åï¼š</label>
                    <input type="text" id="regUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                </div>
                <div class="form-group">
                    <label>æ‰‹æœºå·ï¼š</label>
                    <input type="tel" id="regPhone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·">
                </div>
                <div class="form-group">
                    <label>å¯†ç ï¼š</label>
                    <input type="password" id="regPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="register()">æ³¨å†Œ</button>
                    <button class="btn btn-secondary" onclick="showLoginModal()">è¿”å›ç™»å½•</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let categories = [];
        let products = [];
        let cart = {};
        let currentUser = null; // å½“å‰ç™»å½•ç”¨æˆ·

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            checkUserStatus();
            await Promise.all([
                loadCategories(),
                loadProducts(),
                loadCart()
            ]);
            // ç¡®ä¿è´­ç‰©è½¦æ•°æ®åŠ è½½å®Œæˆåé‡æ–°æ¸²æŸ“å•†å“åˆ—è¡¨
            renderProducts();
        });

        // æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
        function checkUserStatus() {
            const savedUser = localStorage.getItem('currentUser');
            
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                updateUserDisplay(currentUser.username || currentUser.phone, true);
            } else {
                updateUserDisplay('æœªç™»å½•', false);
            }
        }

        // æ›´æ–°ç”¨æˆ·æ˜¾ç¤º
        function updateUserDisplay(displayName, showLogout) {
            const userInfo = document.getElementById('userInfo');
            const logoutBtn = document.getElementById('logoutBtn');
            
            userInfo.textContent = displayName;
            logoutBtn.style.display = showLogout ? 'inline' : 'none';
        }

        // æ˜¾ç¤ºç™»å½•æ¨¡æ€æ¡†
        function showLoginModal() {
            if (currentUser) {
                return; // å·²ç™»å½•ä¸æ˜¾ç¤ºç™»å½•æ¡†
            }
            document.getElementById('loginModal').style.display = 'block';
        }

        // å…³é—­ç™»å½•æ¨¡æ€æ¡†
        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
        }

        // æ˜¾ç¤ºæ³¨å†Œæ¨¡æ€æ¡†
        function showRegisterModal() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('registerModal').style.display = 'block';
        }

        // å…³é—­æ³¨å†Œæ¨¡æ€æ¡†
        function closeRegisterModal() {
            document.getElementById('registerModal').style.display = 'none';
        }

        // ç”¨æˆ·ç™»å½•
        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showMessage('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ', 'error');
                return;
            }

            // è·å–ç™»å½•æŒ‰é’®
            const loginButton = document.querySelector('button[onclick="login()"]');
            
            // åº”ç”¨é˜²é‡å¤æäº¤
            if (!submitManager.canSubmit(loginButton)) {
                return;
            }
            
            submitManager.setButtonSubmitting(loginButton, true, 'ç™»å½•ä¸­...');

            try {
                const result = await api.user.login(username, password);
                if (result.code === 200) {
                    currentUser = result.data;
                    
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    updateUserDisplay(currentUser.username || currentUser.phone, true);
                    closeLoginModal();
                    showMessage('ç™»å½•æˆåŠŸï¼');
                    
                    // é‡æ–°åŠ è½½è´­ç‰©è½¦
                    loadCart();
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                showMessage('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                submitManager.setButtonSubmitting(loginButton, false);
            }
        }

        // ç”¨æˆ·æ³¨å†Œ
        async function register() {
            const username = document.getElementById('regUsername').value;
            const phone = document.getElementById('regPhone').value;
            const password = document.getElementById('regPassword').value;
            
            if (!username || !phone || !password) {
                showMessage('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
                return;
            }

            // è·å–æ³¨å†ŒæŒ‰é’®
            const registerButton = document.querySelector('button[onclick="register()"]');
            
            // åº”ç”¨é˜²é‡å¤æäº¤
            if (!submitManager.canSubmit(registerButton)) {
                return;
            }
            
            submitManager.setButtonSubmitting(registerButton, true, 'æ³¨å†Œä¸­...');

            try {
                const result = await api.user.register(username, phone, password);
                if (result.code === 200) {
                    showMessage('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•');
                    closeRegisterModal();
                    showLoginModal();
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                console.error('æ³¨å†Œå¤±è´¥:', error);
                showMessage('æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                submitManager.setButtonSubmitting(registerButton, false);
            }
        }

        // é€€å‡ºç™»å½•
        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            
            updateUserDisplay('æœªç™»å½•', false);
            cart = {};
            updateCartCount();
            renderProducts();
            showMessage('å·²é€€å‡ºç™»å½•');
        }

        // åŠ è½½å•†å“åˆ†ç±»
        async function loadCategories() {
            const tabsContainer = document.getElementById('categoryTabs');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            tabsContainer.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½åˆ†ç±»...</div>';
            
            try {
                const result = await api.product.getCategories();
                if (result.code === 200) {
                    categories = result.data;
                    renderCategories();
                } else {
                    tabsContainer.innerHTML = '<div class="error">åŠ è½½åˆ†ç±»å¤±è´¥ï¼š' + (result.message || 'æœªçŸ¥é”™è¯¯') + '</div>';
                    showMessage(result.message || 'åŠ è½½åˆ†ç±»å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', error);
                tabsContainer.innerHTML = '<div class="error">åŠ è½½åˆ†ç±»å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
                showMessage('åŠ è½½åˆ†ç±»å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        // æ¸²æŸ“åˆ†ç±»æ ‡ç­¾
        function renderCategories() {
            const tabsContainer = document.getElementById('categoryTabs');
            tabsContainer.innerHTML = '<div class="category-tab active" onclick="filterByCategory(0, this)">å…¨éƒ¨</div>';
            
            categories.forEach(category => {
                const tab = document.createElement('div');
                tab.className = 'category-tab';
                tab.textContent = category.name;
                tab.onclick = () => filterByCategory(category.id, tab);
                tabsContainer.appendChild(tab);
            });
        }

        // åŠ è½½å•†å“åˆ—è¡¨
        async function loadProducts(categoryId = null) {
            const productsList = document.getElementById('productsList');
            
            // ä½¿ç”¨LoadingManageræ˜¾ç¤ºåŠ è½½çŠ¶æ€
            productsList.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½å•†å“...</div>';
            loadingManager.show('æ­£åœ¨åŠ è½½å•†å“...');
            
            try {
                const result = await api.product.getProductsByCategory(categoryId);
                if (result.code === 200) {
                    products = result.data;
                    renderProducts();
                } else {
                    productsList.innerHTML = '<div class="error">åŠ è½½å•†å“å¤±è´¥ï¼š' + (result.message || 'æœªçŸ¥é”™è¯¯') + '</div>';
                    showMessage(result.message || 'åŠ è½½å•†å“å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åŠ è½½å•†å“å¤±è´¥:', error);
                productsList.innerHTML = '<div class="error">åŠ è½½å•†å“å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
                showMessage('åŠ è½½å•†å“å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            } finally {
                loadingManager.hide();
            }
        }

        // æ¸²æŸ“å•†å“åˆ—è¡¨
        function renderProducts() {
            const productsList = document.getElementById('productsList');
            
            if (products.length === 0) {
                productsList.innerHTML = '<div class="error">æš‚æ— å•†å“</div>';
                return;
            }

            productsList.innerHTML = products.map(product => {
                const cartQuantity = cart[product.id] || 0;
                const originalPriceHtml = product.originalPrice ? 
                    `<span class="original-price">Â¥${product.originalPrice}</span>` : '';
                
                return `
                    <div class="product-card">
                        <div class="product-image">ğŸ½ï¸</div>
                        <div class="product-info">
                            <div class="product-name">${product.name}</div>
                            <div class="product-description">${product.description || ''}</div>
                            <div class="product-price">
                                <span class="current-price">Â¥${product.price}</span>
                                ${originalPriceHtml}
                            </div>
                            <div class="product-actions">
                                ${cartQuantity > 0 ? `
                                    <div class="quantity-control">
                                        <button class="quantity-btn" onclick="updateQuantity(${product.id}, -1)">-</button>
                                        <span class="quantity-display">${cartQuantity}</span>
                                        <button class="quantity-btn" onclick="updateQuantity(${product.id}, 1)">+</button>
                                    </div>
                                ` : `
                                    <button class="btn btn-primary add-to-cart-btn" data-product-id="${product.id}">åŠ å…¥è´­ç‰©è½¦</button>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // ä¸ºæ–°æ·»åŠ çš„è´­ç‰©è½¦æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const productId = parseInt(this.dataset.productId);
                    addToCart(productId, this);
                });
            });
        }

        // æŒ‰åˆ†ç±»ç­›é€‰å•†å“
        function filterByCategory(categoryId, element) {
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // å¦‚æœä¼ å…¥äº†elementå‚æ•°ï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™æŸ¥æ‰¾å¯¹åº”çš„å…ƒç´ 
            if (element) {
                element.classList.add('active');
            } else {
                // é€šè¿‡categoryIdæŸ¥æ‰¾å¯¹åº”çš„tab
                const tabs = document.querySelectorAll('.category-tab');
                if (categoryId === 0) {
                    tabs[0].classList.add('active'); // "å…¨éƒ¨"æ ‡ç­¾
                } else {
                    tabs.forEach(tab => {
                        if (tab.textContent === categories.find(c => c.id === categoryId)?.name) {
                            tab.classList.add('active');
                        }
                    });
                }
            }

            // åŠ è½½å¯¹åº”åˆ†ç±»çš„å•†å“
            if (categoryId === 0) {
                loadProducts();
            } else {
                loadProducts(categoryId);
            }
        }

        // æ·»åŠ åˆ°è´­ç‰©è½¦
        async function addToCart(productId, buttonElement) {
            if (!currentUser) {
                showLoginModal();
                return;
            }
            
            // åº”ç”¨é˜²é‡å¤æäº¤
            if (!submitManager.canSubmit(buttonElement)) {
                return;
            }
            
            submitManager.setButtonSubmitting(buttonElement, true, 'æ·»åŠ ä¸­...');
            
            try {
                const result = await api.cart.addToCart(currentUser.id, productId, 1);
                if (result.code === 200) {
                    cart[productId] = (cart[productId] || 0) + 1;
                    updateCartCount();
                    renderProducts();
                    showMessage('æ·»åŠ æˆåŠŸ');
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                console.error('æ·»åŠ è´­ç‰©è½¦å¤±è´¥:', error);
                showMessage('æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                submitManager.setButtonSubmitting(buttonElement, false);
            }
        }

        // æ›´æ–°å•†å“æ•°é‡
        async function updateQuantity(productId, change) {
            const newQuantity = (cart[productId] || 0) + change;
            
            if (newQuantity <= 0) {
                await removeFromCart(productId);
                return;
            }

            loadingManager.show('æ­£åœ¨æ›´æ–°æ•°é‡...');
            
            try {
                const result = await api.cart.updateCartQuantity(currentUser.id, productId, newQuantity);
                if (result.code === 200) {
                    cart[productId] = newQuantity;
                    updateCartCount();
                    renderProducts();
                    showMessage('æ•°é‡æ›´æ–°æˆåŠŸ');
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                console.error('æ›´æ–°æ•°é‡å¤±è´¥:', error);
                showMessage('æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            } finally {
                loadingManager.hide();
            }
        }

        // ä»è´­ç‰©è½¦ç§»é™¤
        async function removeFromCart(productId) {
            loadingManager.show('æ­£åœ¨ç§»é™¤å•†å“...');
            
            try {
                const result = await api.cart.removeFromCart(currentUser.id, productId);
                if (result.code === 200) {
                    delete cart[productId];
                    updateCartCount();
                    renderProducts();
                    showMessage('å·²ä»è´­ç‰©è½¦ç§»é™¤');
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                console.error('ç§»é™¤å¤±è´¥:', error);
                showMessage('ç§»é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            } finally {
                loadingManager.hide();
            }
        }

        // åŠ è½½è´­ç‰©è½¦
        async function loadCart() {
            cart = {};
            
            if (currentUser) {
                // ç™»å½•ç”¨æˆ·ï¼šä»æœåŠ¡å™¨åŠ è½½
                try {
                    loadingManager.show('æ­£åœ¨åŠ è½½è´­ç‰©è½¦...');
                    const result = await api.cart.getCartItems(currentUser.id);
                    if (result.code === 200) {
                        result.data.forEach(item => {
                            cart[item.productId] = item.quantity;
                        });
                    }
                } catch (error) {
                    console.error('åŠ è½½è´­ç‰©è½¦å¤±è´¥:', error);
                } finally {
                    loadingManager.hide();
                }
            }
            
            updateCartCount();
            // é‡æ–°æ¸²æŸ“å•†å“åˆ—è¡¨ä»¥æ˜¾ç¤ºè´­ç‰©è½¦æ•°é‡
            if (products.length > 0) {
                renderProducts();
            }
        }

        // æ›´æ–°è´­ç‰©è½¦æ•°é‡æ˜¾ç¤º
        function updateCartCount() {
            const totalItems = Object.values(cart).reduce((sum, quantity) => sum + quantity, 0);
            document.getElementById('cartCount').textContent = totalItems;
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showMessage(message, type = 'success') {
            // åˆ›å»ºæç¤ºå…ƒç´ 
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                background-color: ${type === 'success' ? '#4caf50' : '#f44336'};
                color: white;
                border-radius: 4px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            // 3ç§’åç§»é™¤
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // æ˜¾ç¤ºæ‰€æœ‰å•†å“
        function showAllProducts() {
            loadProducts();
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector('.category-tab').classList.add('active');
        }

        // æ˜¾ç¤ºè´­ç‰©è½¦é¡µé¢
        function showCart() {
            window.location.href = 'cart.html';
        }

        // æ˜¾ç¤ºè®¢å•é¡µé¢
        function showOrders() {
            window.location.href = 'orders.html';
        }

        // æ˜¾ç¤ºç®¡ç†é¡µé¢
        function showAdmin() {
            window.location.href = 'admin.html';
        }

        // æ˜¾ç¤ºé’±åŒ…é¡µé¢
        function showWallet() {
            window.location.href = 'wallet.html';
        }

        // æ˜¾ç¤ºä¸ªäººèµ„æ–™é¡µé¢
        function showProfile() {
            if (!currentUser) {
                showMessage('è¯·å…ˆç™»å½•', 'error');
                showLoginModal();
                return;
            }
            window.location.href = 'profile.html';
        }

        // æ·»åŠ åŠ¨ç”»æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>